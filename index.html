<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>#chill-pill-project-2</title>
  <style>
    body {
      background: linear-gradient(135deg, #1a120b, #3c2f2f);
      color: #ffefcd;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      overflow-x: hidden;
    }

    h1 {
      color: #f4a261;
      text-align: center;
    }

    nav {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding-bottom: 30px;
      margin-bottom: 50px;
      border-bottom: 2px solid #f4a261;
    }

    nav button,
    .controls button,
    .playlist-builder button,
    .upload-section button {
      background: #ffb703;
      border: none;
      color: #1a120b;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
    }

    section {
      display: none;
    }

    section.active {
      display: block;
    }

    .playlist {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .song {
      padding: 10px 20px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: 0.3s;
      width: 90%;
      max-width: 500px;
      text-align: center;
    }

    .song:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .song.active {
      border: 2px solid #ffb703;
      background-color: rgba(255, 183, 3, 0.3);
    }

    .song.selected {
      border: 2px solid #ffd166;
      background: rgba(255, 255, 255, 0.3);
    }

    input[type="text"],
    input[type="file"] {
      margin: 5px;
      padding: 8px;
      border-radius: 15px;
      border: none;
    }

    #dropzone {
      border: 2px dashed #ffb703;
      padding: 20vh 0;
      border-radius: 15px;
      text-align: center;
      color: #ccc;
      margin: auto;
      font-size: 20px;
      width: 80vw;
      cursor: pointer;
    }

    .search-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .search-bar input {
      width: 300px;
      padding: 10px;
      border-radius: 20px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #ffb703;
      font-size: 16px;
      transition: background 0.3s;
    }

    .playlist-builder {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    #dropzone.dragover {
      background: rgba(255, 183, 3, 0.2);
      border-color: #fff;
      color: #fff;
    }

    #progressText {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
      color: #ffb703;
      animation: fadein 0.3s ease-in-out;
    }

    @keyframes fadein {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    canvas {
      display: block;
      margin: 20px auto;
      width: 100%;
      max-width: 600px;
      height: 100px;
    }

    .controls {
      position: sticky;
      bottom: 0;
      background: #1a120b;
      padding: 10px 0;
      z-index: 999;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .controls-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .duration-display {
      color: #ccc;
      font-size: 14px;
      margin-top: 5px;
    }

    .progress-container {
      width: 90%;
      max-width: 600px;
      height: 6px;
      background: #555;
      border-radius: 5px;
      overflow: hidden;
      margin: 10px auto;
      cursor: pointer;
    }

    .progress-bar {
      height: 100%;
      background: #ffb703;
      width: 0%;
      transition: width 0.2s linear;
    }

    #nowPlayingTitle {
      color: #ffb703;
      font-weight: bold;
      margin: 5px;
      text-align: center;
    }

    #meteorCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: -1;
    }

    button.toggle-active {
      box-shadow: 0 0 10px #ffb703;
      opacity: 1;
    }

    button.toggle-inactive {
      opacity: 0.5;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <h1>
    <center>
      <h5 style="margin: 0px; font-size: 20px; font-family: Verdana, Geneva, Tahoma, sans-serif; font-weight: 100;">
        #chill-pill-project-2</h5>
    </center>
    <h1 style="font-size: 40px;">Music Player</h1>
    <center>
      <h5
        style="margin: 0px 0px 10px 0px; font-size: 20px; font-family: Verdana, Geneva, Tahoma, sans-serif; font-weight: 100;">
        By Ansh</h5>
    </center>
  </h1>

  <nav>
    <button onclick="switchTab('upload')" style="display: none;">Upload</button>
    <button onclick="switchTab('player', true)">Player</button>
  </nav>

  <section id="upload" class="upload-section">
    <h2 style="text-align:center;">Upload Your Song</h2>
    <input type="file" id="uploadInput" accept=".mp3" style="display:none">
    <div id="dropzone" onclick="document.getElementById('uploadInput').click()">Click or Drag & Drop songs here</div>
    <div id="progressText"></div>
  </section>

  <section id="player" class="play-section active">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search songs..." oninput="filterSongs()">
    </div>
    <div class="playlist-builder">
      <button onclick="toggleSelectionMode()">Select Songs</button>
      <button disabled onclick="createCustomPlaylist()">Create Playlist</button>
      <button onclick="shuffleSongs()">Shuffle All</button>
    </div>
    <div id="playlist" class="playlist">Loading songs...</div>
    <audio id="audio" controls style="display:none;"></audio>
    <canvas id="visualizer"></canvas>
    <div class="controls">
      <div class="progress-container" onclick="setProgress(event)">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="controls-buttons">
        <button onclick="prevSong()">⏮</button>
        <button id="togglePlay" onclick="toggleAudio()">▶</button>
        <button onclick="nextSong()">⏭</button>
      </div>
      <div class="duration-display" id="durationDisplay">00:00 / 00:00</div>
      <div id="nowPlayingTitle"></div>
    </div>
  </section>

  <canvas id="meteorCanvas"></canvas>

  <script>
    const GITHUB_TOKEN = "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";
    const GITHUB_API_URL = "https://api.github.com/repos/Ansh4044/-chill-pill-project-2/contents/songs";


    const uploadInput = document.getElementById("uploadInput");
    const dropzone = document.getElementById("dropzone");
    const progressText = document.getElementById("progressText");
    const playlistEl = document.getElementById("playlist");
    const audio = document.getElementById("audio");
    const durationDisplay = document.getElementById("durationDisplay");
    const progressBar = document.getElementById("progressBar");
    const nowPlayingTitle = document.getElementById("nowPlayingTitle");
    const togglePlayBtn = document.getElementById("togglePlay");

    let allSongs = [], currentIndex = -1, playlistQueue = [], selectionMode = false, selectedSongs = [];

    function toggleAudio() {
      if (audio.paused) {
        audio.play();
        togglePlayBtn.innerHTML = "⏸";
      } else {
        audio.pause();
        togglePlayBtn.innerHTML = "▶";
      }
    }

    audio.addEventListener("ended", nextSong);
    audio.addEventListener("timeupdate", () => {
      durationDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
      if (!isNaN(audio.duration)) {
        progressBar.style.width = (audio.currentTime / audio.duration) * 100 + "%";
      }
    });

    function formatTime(s) {
      if (isNaN(s)) return "00:00";
      const m = Math.floor(s / 60).toString().padStart(2, "0");
      const ss = Math.floor(s % 60).toString().padStart(2, "0");
      return `${m}:${ss}`;
    }

    function setProgress(e) {
      const percent = e.offsetX / e.currentTarget.clientWidth;
      audio.currentTime = percent * audio.duration;
    }

    function startPlayback(queue) {
      playlistQueue = queue;
      currentIndex = 0;
      playIndex();
    }

    function playIndex() {
      const song = playlistQueue[currentIndex];
      const songEls = document.querySelectorAll(".song");
      songEls.forEach(el => el.classList.remove("active"));
      const el = songEls[currentIndex];
      el?.classList.add("active");
      audio.src = song.download_url;
      nowPlayingTitle.textContent = song.name.replace(".mp3", "");
      audio.play();
      togglePlayBtn.innerHTML = "⏸";
    }

    function prevSong() {
      if (currentIndex > 0) currentIndex--;
      playIndex();
    }

    function nextSong() {
      if (currentIndex + 1 < playlistQueue.length) currentIndex++;
      playIndex();
    }

    function toggleSelectionMode() {
      selectionMode = !selectionMode;
      selectedSongs = [];
      document.querySelectorAll(".song").forEach(d => d.classList.remove("selected"));

      const selectBtn = document.querySelector(".playlist-builder button:nth-child(1)");
      const createBtn = document.querySelector(".playlist-builder button:nth-child(2)");

      if (selectionMode) {
        selectBtn.classList.add("toggle-active");
        selectBtn.classList.remove("toggle-inactive");
        createBtn.disabled = true;
      } else {
        selectBtn.classList.remove("toggle-active");
        selectBtn.classList.add("toggle-inactive");
        createBtn.disabled = false;
      }
    }


    function createCustomPlaylist() {
      if (selectedSongs.length) {
        playlistQueue = [...selectedSongs];
        selectionMode = false;
        displaySongs(playlistQueue);
        startPlayback(playlistQueue);
      }
    }

    function shuffleSongs() {
      const arr = playlistQueue.length ? playlistQueue : allSongs;
      playlistQueue = [...arr].sort(() => Math.random() - 0.5);
      displaySongs(playlistQueue);
      startPlayback(playlistQueue);
    }

    async function fetchSongs() {
      playlistEl.innerHTML = "Loading songs...";
      const res = await fetch(GITHUB_API_URL);
      const data = await res.json();
      allSongs = data.filter(file => file.name.endsWith(".mp3"));
      displaySongs(allSongs);
    }

    function displaySongs(arr) {
      playlistEl.innerHTML = "";
      arr.forEach((song, i) => {
        const d = document.createElement("div");
        d.className = "song";
        d.textContent = song.name.replace(".mp3", "");
        d.addEventListener("click", () => {
          if (selectionMode) {
            d.classList.toggle("selected");
            const idx = selectedSongs.indexOf(song);
            idx > -1 ? selectedSongs.splice(idx, 1) : selectedSongs.push(song);

            // Update Create Playlist button
            const createBtn = document.querySelector(".playlist-builder button:nth-child(2)");
            createBtn.disabled = selectedSongs.length === 0;
          } else {
            startPlayback([song]);
          }
        });

        playlistEl.appendChild(d);
      });
    }

    function filterSongs() {
      const q = document.getElementById("searchInput").value.toLowerCase();
      displaySongs(allSongs.filter(s => s.name.toLowerCase().includes(q)));
    }

    function switchTab(id, reload = false) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (reload) window.location.reload();
    }

    uploadInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (file?.name.endsWith(".mp3")) uploadToGitHub(file);
    });
    dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("dragover"); });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", e => {
      e.preventDefault(); dropzone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file?.name.endsWith(".mp3")) uploadToGitHub(file);
    });

    async function uploadToGitHub(file) {
      progressText.textContent = "Uploading...";
      const reader = new FileReader();
      reader.onload = async () => {
        const fileContent = reader.result.split(",")[1];

        const res = await fetch("/.netlify/functions/upload", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            fileName: file.name,
            fileContent: fileContent
          })
        });

        const data = await res.json();
        if (res.ok) {
          progressText.textContent = "Upload Complete!";
          fetchSongs();
        } else {
          progressText.textContent = "Upload Failed! " + data.error;
        }

        setTimeout(() => (progressText.textContent = ""), 3000);
      };

      reader.readAsDataURL(file);
    }



    // Meteor shower
    const mCanvas = document.getElementById("meteorCanvas");
    const ctx = mCanvas.getContext("2d");
    mCanvas.width = window.innerWidth;
    mCanvas.height = window.innerHeight;
    let meteors = [];
    function createMeteor() {
      meteors.push({ x: Math.random() * mCanvas.width, y: 0, length: Math.random() * 20 + 10, speed: Math.random() * 4 + 2 });
    }
    function drawM() {
      ctx.clearRect(0, 0, mCanvas.width, mCanvas.height);
      ctx.strokeStyle = "rgba(255,255,255,0.7)";
      ctx.lineWidth = 2;
      meteors.forEach((m, i) => {
        ctx.beginPath();
        ctx.moveTo(m.x, m.y);
        ctx.lineTo(m.x + m.length, m.y + m.length);
        ctx.stroke();
        m.x += m.speed;
        m.y += m.speed;
        if (m.x > mCanvas.width || m.y > mCanvas.height) meteors.splice(i, 1);
      });
    }
    function animateM() { drawM(); requestAnimationFrame(animateM); }
    setInterval(createMeteor, 300);
    animateM();

    window.onload = () => {
      fetchSongs();
      togglePlayBtn.innerHTML = "▶";
    };
  </script>
</body>

</html>